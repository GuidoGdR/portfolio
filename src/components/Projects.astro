---
import { getCollection } from "astro:content";
import ProjectCard from "./ProjectCard.astro";
import { type ImageMetadata } from 'astro';
import type CustomImageMetadata from '../types/CustomImageMetadata';

const projects = await getCollection('projects')

function getPorjectsImgaes(){
    
    // 游눠 CAMBIO CLAVE: Usa un patr칩n m치s amplio para que Vite/Astro pueda encontrar todas las im치genes.
    // El '*' en la carpeta representa CUALQUIER nombre de carpeta/slug de proyecto.
    const allProjectsImages = import.meta.glob<{default:ImageMetadata}>( '../assets/projects/*/*.{png,jpg,jpeg,gif,webp}'); 

    const result: {[key:string]: Promise<CustomImageMetadata>[]} = {}
    
    projects.forEach((project => {
        const projectImages: Promise<CustomImageMetadata>[] = [];
        
        // El patr칩n para encontrar las im치genes del proyecto espec칤fico
        // Aseg칰rate de que los slashes sean correctos para la comparaci칩n de claves.
        const reg_exp = new RegExp(`^\\.\\.\\/assets\\/projects\\/${project.slug}\\/[^\\/]+\\.(png|jpg|jpeg|gif|webp)$`); 
        
        // Itera sobre las claves (rutas) que Vite/Astro encontr칩.
        for(const key in allProjectsImages) {
            if( reg_exp.test(key) ){
                // Esta funci칩n importada din치micamente retorna una PROMESA de ImageMetadata
                const imageImportPromise = allProjectsImages[key]().then(module => {

                    const start = module.default.src.lastIndexOf('/') + 1
                    let end = module.default.src.indexOf('?')
                    let text = module.default.src.slice(start, end)
                    end = text.indexOf('.')
                    text = text.slice(0, end)
                    text = text.replaceAll('_', ' ')
                    text = text.replaceAll('-', ' - ')

                    return {...module.default, alt: text}
                });
                projectImages.push(imageImportPromise)
            }
        }
        
        if (projectImages.length > 0) {
            result[project.slug] = projectImages;
        }
    }));
    return result
};

const projectsImages = getPorjectsImgaes();

---
<section id="projects" class="projects">
    <div class="container">
        <h2>游눹 Proyectos p칰blicos</h2>
        <div class="cards-wrapper">
            {
                projects.map((project)=>{
                    const data = project.data;
                    return <ProjectCard title={data.title} images={projectsImages[project.slug] }
                        tecnologies={data.tecnologies} 
                        description={project.render()}
                        repoUrl={data.repoUrl}/>
                })
            }
            
        </div>
    </div>
</section>

<style>

    .projects {
        padding: 60px 0;
        text-align: center;
        background-color: var(--background-light);
    }

    .projects h2 {
        font-size: 2rem;
        margin-bottom: 40px;
        color: var(--text-color);
    }

    .cards-wrapper {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
    }

</style>
